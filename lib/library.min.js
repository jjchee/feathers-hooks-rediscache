!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("library",[],t):"object"==typeof exports?exports.library=t():e.library=t()}(global,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("qs")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("redis")},function(e,t,r){"use strict";r.r(t);var n=r(3),s=r.n(n);class o{constructor(e){this.client=e}clearSingle(e){return new Promise((t,r)=>{this.client.del(""+e,(e,n)=>{e&&r(!1),1===n&&t(!0),t(!1)})})}clearGroup(e){return new Promise((t,r)=>{this.client.lrange(e,0,-1,(n,s)=>{n&&r(n),this.clearAll(s).then(this.client.del(e,(e,r)=>{t(1===r)}))})})}clearAll(e){return new Promise(t=>{e.length||t(!1);let r=0;for(;r<e.length;r++)this.clearSingle(e[r]).then(n=>{r===e.length-1&&t(n)})})}}var a=function(e){const t=s.a.Router(),r=e.get("redisClient"),n=new o(r);return t.get("/clear",(e,t)=>{r.flushall("ASYNC",()=>{t.status(200).json({message:"Cache cleared",status:200})})}),t.get("/clear/single/*",(e,t)=>{let s=decodeURIComponent(e.params[0]);const o=e.query,a=o&&0!==Object.keys(o).length;s.length?(a&&(s=decodeURIComponent(e.url.split("/").slice(3).join("/"))),r.get(""+s,(e,r)=>{e?t.status(500).json({message:"something went wrong"+e.message}):r?n.clearSingle(s).then(e=>{t.status(200).json({message:`cache cleared for key (${a?"with":"without"} params): ${s}`,status:200})}):t.status(200).json({message:`cache already cleared for key (${a?"with":"without"} params): ${s}`,status:204})})):t.status(404).end()}),t.get("/clear/group/*",(e,t)=>{let s=decodeURIComponent(e.params[0]);s.length?(s="group-"+s,r.lrange(s,0,-1,(r,o)=>{r?t.status(500).json({message:"something went wrong"+r.message}):o&&Array.isArray(o)&&o.length>0?n.clearGroup(s).then(r=>{t.status(200).json({message:"cache cleared for the group key: "+decodeURIComponent(e.params[0]),status:200})}):t.status(200).json({message:"cache already cleared for the group key: "+decodeURIComponent(e.params[0]),status:204})})):t.status(404).end()}),t},c=r(4),i=r.n(c),u=r(0),l=r.n(u);const d={defaultDuration:86400};var p=r(1),h=r.n(p),f=r(2),g=r.n(f);function m(e,t={removePathFromCacheKey:!1,parseNestedRoutes:!1}){const r=e.params.query||{},n=t.removePathFromCacheKey,s=t.parseNestedRoutes;let o=n&&e.id?"":""+e.path;return!n&&s&&(o=function(e,t){const r=new RegExp(":([^\\/\\?]+)\\??","g");let n=null;for(;null!==(n=r.exec(e));)Object.keys(t.route).includes(n[1])&&(e=e.replace(n[0],t.route[n[1]]));return e}(o,e.params)),e.id?(0===o.length||n||(o+="/"),Object.keys(r).length>0?o+=`${e.id}?${g.a.stringify(r,{encode:!1})}`:o+=""+e.id):Object.keys(r).length>0&&(o+="?"+g.a.stringify(r,{encode:!1})),o}const y={env:"production",defaultDuration:86400,immediateCacheKey:!1};t.default={redisClient:function(){const e=this,t=e.get("redisCache")||{},r=t.retryInterval||1e4,n=Object.assign({},this.get("redis"),{retry_strategy:function(n){return e.set("redisClient",void 0),"test"!==t.env&&console.log(l.a.yellow("[redis]")+" not connected"),r}}),s=i.a.createClient(n);return e.set("redisClient",s),s.on("ready",()=>{e.set("redisClient",s),"test"!==t.env&&console.log(l.a.green("[redis]")+" connected")}),this},cacheRoutes:a,hookCache:function(e){return function(t){const r=t.app.get("redisCache");if(e=Object.assign({},d,r,e),!t.result.hasOwnProperty("cache")){let r={};if(Array.isArray(t.result)){const e=t.result;r.wrapped=e,t.result={}}r=Object.assign({},r,{cached:!1,duration:e.duration||e.defaultDuration}),t.result.cache=r}return Promise.resolve(t)}},hookRemoveCacheInformation:function(e){return function(e){return e.result.hasOwnProperty("cache")&&delete e.result.cache,Promise.resolve(e)}},redisBeforeHook:function(e){return function(t){const r=t.app.get("redisCache");return e=Object.assign({},y,r,e),new Promise(r=>{const n=t.app.get("redisClient");n||r(t);const s=m(t,e);n.get(s,(n,o)=>{if(null!==n&&r(t),o){let n=JSON.parse(o);const a=h()(n.cache.expiresOn).format("DD MMMM YYYY - HH:mm:ss");t.result=n,r(t),"test"!==e.env&&(console.log(`${l.a.cyan("[redis]")} returning cached value for ${l.a.green(s)}.`),console.log(`> Expires on ${a}.`))}else!0===e.immediateCacheKey&&(t.params.cacheKey=s),r(t)})})}},redisAfterHook:function(e){return function(t){const r=t.app.get("redisCache");return e=Object.assign({},y,r,e),new Promise(r=>{if(!t.result.cache.cached){const n=t.result.cache.duration||e.defaultDuration,s=t.app.get("redisClient");s||r(t);const o=t.params.cacheKey||m(t,e);Object.assign(t.result.cache,{cached:!0,duration:n,expiresOn:h()().add(h.a.duration(n,"seconds")),parent:t.path,group:t.path?"group-"+t.path:"",key:o}),s.set(o,JSON.stringify(t.result)),s.expire(o,t.result.cache.duration),"test"!==e.env&&(console.log(`${l.a.cyan("[redis]")} added ${l.a.green(o)} to the cache.`),console.log(`> Expires in ${h.a.duration(n,"seconds").humanize()}.`))}if(t.result.cache.hasOwnProperty("wrapped")){const{wrapped:e}=t.result.cache;t.result=e}r(t)})}}}}])}));
//# sourceMappingURL=library.min.js.map