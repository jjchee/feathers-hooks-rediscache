!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("library",[],t):"object"==typeof exports?exports.library=t():e.library=t()}(global,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("qs")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("redis")},function(e,t,n){"use strict";n.r(t);var r=n(3),o=n.n(r);function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,i(r.key),r)}}function i(e){var t=function(e,t){if("object"!=a(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=a(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==a(t)?t:String(t)}var s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.client=t}var t,n,r;return t=e,(n=[{key:"clearSingle",value:function(e){var t=this;return new Promise((function(n,r){t.client.del("".concat(e),(function(e,t){e&&r(!1),1===t&&n(!0),n(!1)}))}))}},{key:"clearGroup",value:function(e){var t=this;return new Promise((function(n,r){t.client.lrange(e,0,-1,(function(o,a){o&&r(o),t.clearAll(a).then(t.client.del(e,(function(e,t){n(1===t)})))}))}))}},{key:"clearAll",value:function(e){var t=this;return new Promise((function(n){e.length||n(!1);for(var r=0;r<e.length;r++)t.clearSingle(e[r]).then((function(t){r===e.length-1&&n(t)}))}))}}])&&c(t.prototype,n),r&&c(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();var u=function(e){var t=o.a.Router(),n=e.get("redisClient"),r=new s(n);return t.get("/clear",(function(e,t){n.flushall("ASYNC",(function(){t.status(200).json({message:"Cache cleared",status:200})}))})),t.get("/clear/single/*",(function(e,t){var o=decodeURIComponent(e.params[0]),a=e.query,c=a&&0!==Object.keys(a).length;o.length?(c&&(o=decodeURIComponent(e.url.split("/").slice(3).join("/"))),n.get("".concat(o),(function(e,n){e?t.status(500).json({message:"something went wrong"+e.message}):n?r.clearSingle(o).then((function(e){t.status(200).json({message:"cache cleared for key (".concat(c?"with":"without"," params): ").concat(o),status:200})})):t.status(200).json({message:"cache already cleared for key (".concat(c?"with":"without"," params): ").concat(o),status:204})}))):t.status(404).end()})),t.get("/clear/group/*",(function(e,t){var o=decodeURIComponent(e.params[0]);o.length?(o="group-"+o,n.lrange(o,0,-1,(function(n,a){n?t.status(500).json({message:"something went wrong"+n.message}):a&&Array.isArray(a)&&a.length>0?r.clearGroup(o).then((function(n){t.status(200).json({message:"cache cleared for the group key: ".concat(decodeURIComponent(e.params[0])),status:200})})):t.status(200).json({message:"cache already cleared for the group key: ".concat(decodeURIComponent(e.params[0])),status:204})}))):t.status(404).end()})),t},l=n(4),f=n.n(l),d=n(0),p=n.n(d);var g={defaultDuration:86400};var h=n(1),y=n.n(h),m=n(2),v=n.n(m);function b(e,t){for(var n=new RegExp(":([^\\/\\?]+)\\??","g"),r=null;null!==(r=n.exec(e));)Object.keys(t.route).includes(r[1])&&(e=e.replace(r[0],t.route[r[1]]));return e}function j(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{removePathFromCacheKey:!1,parseNestedRoutes:!1},n=e.params.query||{},r=t.removePathFromCacheKey,o=t.parseNestedRoutes,a=r&&e.id?"":"".concat(e.path);return!r&&o&&(a=b(a,e.params)),e.id?(0===a.length||r||(a+="/"),Object.keys(n).length>0?a+="".concat(e.id,"?").concat(v.a.stringify(n,{encode:!1})):a+="".concat(e.id)):Object.keys(n).length>0&&(a+="?".concat(v.a.stringify(n,{encode:!1}))),a}var w={env:"production",defaultDuration:86400,immediateCacheKey:!1};t.default={redisClient:function(){var e=this,t=e.get("redisCache")||{},n=t.retryInterval||1e4,r=Object.assign({},this.get("redis"),{retry_strategy:function(r){return e.set("redisClient",void 0),"test"!==t.env&&console.log("".concat(p.a.yellow("[redis]")," not connected")),n}}),o=f.a.createClient(r);return e.set("redisClient",o),o.on("ready",(function(){e.set("redisClient",o),"test"!==t.env&&console.log("".concat(p.a.green("[redis]")," connected"))})),this},cacheRoutes:u,hookCache:function(e){return function(t){var n=t.app.get("redisCache");if(e=Object.assign({},g,n,e),!t.result.hasOwnProperty("cache")){var r={};if(Array.isArray(t.result)){var o=t.result;r.wrapped=o,t.result={}}r=Object.assign({},r,{cached:!1,duration:e.duration||e.defaultDuration}),t.result.cache=r}return Promise.resolve(t)}},hookRemoveCacheInformation:function(e){return function(e){return e.result.hasOwnProperty("cache")&&delete e.result.cache,Promise.resolve(e)}},redisBeforeHook:function(e){return function(t){var n=t.app.get("redisCache");return e=Object.assign({},w,n,e),new Promise((function(n){var r=t.app.get("redisClient");r||n(t);var o=j(t,e);r.get(o,(function(r,a){if(null!==r&&n(t),a){var c=JSON.parse(a),i=y()(c.cache.expiresOn).format("DD MMMM YYYY - HH:mm:ss");t.result=c,n(t),"test"!==e.env&&(console.log("".concat(p.a.cyan("[redis]")," returning cached value for ").concat(p.a.green(o),".")),console.log("> Expires on ".concat(i,".")))}else!0===e.immediateCacheKey&&(t.params.cacheKey=o),n(t)}))}))}},redisAfterHook:function(e){return function(t){var n=t.app.get("redisCache");return e=Object.assign({},w,n,e),new Promise((function(n){if(!t.result.cache.cached){var r=t.result.cache.duration||e.defaultDuration,o=t.app.get("redisClient");o||n(t);var a=t.params.cacheKey||j(t,e);Object.assign(t.result.cache,{cached:!0,duration:r,expiresOn:y()().add(y.a.duration(r,"seconds")),parent:t.path,group:t.path?"group-".concat(t.path):"",key:a}),o.set(a,JSON.stringify(t.result)),o.expire(a,t.result.cache.duration),"test"!==e.env&&(console.log("".concat(p.a.cyan("[redis]")," added ").concat(p.a.green(a)," to the cache.")),console.log("> Expires in ".concat(y.a.duration(r,"seconds").humanize(),".")))}if(t.result.cache.hasOwnProperty("wrapped")){var c=t.result.cache.wrapped;t.result=c}n(t)}))}}}}])}));
//# sourceMappingURL=library.min.js.map